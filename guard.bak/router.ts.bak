import type { Express, RequestHandler } from 'express'

import type { Method, Type } from '@/core/decorators/types'
import { Container } from '@/core/container'
import {
  getControllerPrefix,
  getControllers,
  getProviders,
} from '@/core/decorators/metadata'
import { getRoutes } from '@/core/decorators/method'
import { isGuarded } from '@/core/guard/decorator'
import { createJwtGuard } from '@/core/guard/jwt'
import { createRouteHandler } from '@/core/route-handler'

import AuthService from '@/app/auth/auth.service'
import JwtService from '@/common/services/jwt.service'

export async function registerRoutes(app: Express, App: Type) {
  const controllers = getControllers(App)
  const providers = getProviders(App)

  const container = new Container()
  container.register(providers)

  for (const ControllerClass of controllers) {
    const prefix = getControllerPrefix(ControllerClass)

    const paramTypes = (Reflect.getMetadata(
      'design:paramtypes',
      ControllerClass,
    ) ?? []) as Type[]

    const dependencies = paramTypes.map((param) =>
      container.resolve(param as never),
    )
    const controller = new ControllerClass(...dependencies) as never

    const routes = getRoutes(ControllerClass)
    await Promise.all(
      routes.map((route) => {
        const handler = createRouteHandler(controller, String(route.name))
        const method = route.method.toLowerCase() as Method
        const path = `${prefix}${route.path}`.replace(/\/+/g, '/')

        // const middlewares: RequestHandler[] = []
        // if (isGuarded(controller, route.name)) {
        //   const jwt = container.resolve(JwtService)
        //   const authService = container.resolve(AuthService)
        //   middlewares.push(createJwtGuard(jwt, authService))
        // }

        app[method](path, handler)
      }),
    )
  }
}
